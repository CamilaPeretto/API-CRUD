<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estoque de Produtos</title>
  <link rel="shortcut icon" href="./img/carrinho-de-compras.png" type="image/x-icon" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6 flex flex-col items-center font-sans">
  <h1 class="text-4xl font-extrabold mb-8 text-gray-900">
    Estoque de Produtos
  </h1>

  <form id="form-produto" class="w-full max-w-3xl bg-white rounded-lg shadow-md p-6 mb-8 grid gap-4">
    <input id="nome" type="text" placeholder="Nome do produto"
      class="border border-gray-300 p-3 rounded-md w-full focus:outline-blue-500" required />

    <input id="descricao" type="text" placeholder="Descrição"
      class="border border-gray-300 p-3 rounded-md w-full focus:outline-blue-500" required />

    <input id="preco" type="number" placeholder="Preço" min="0.01" step="0.01"
      class="border border-gray-300 p-3 rounded-md w-full focus:outline-blue-500" required />

    <input id="estoque" type="number" placeholder="Estoque" min="0" step="1"
      class="border border-gray-300 p-3 rounded-md w-full focus:outline-blue-500" required />

    <select id="categoria" class="border border-gray-300 p-3 rounded-md w-full focus:outline-blue-500" required>
      <option value="" disabled selected>Selecione a categoria</option>
      <option value="Cabelos">Cabelos</option>
      <option value="Unhas">Unhas</option>
      <option value="Pele">Pele</option>
      <option value="Maquiagem">Maquiagem</option>
    </select>

    <input id="input-imagem" type="file" accept="image/*"
      class="border border-gray-300 p-2 rounded-md w-full focus:outline-blue-500" />

    <img id="preview" src="" alt="Prévia da imagem"
      class="w-32 h-32 object-cover mt-2 hidden rounded-md border border-gray-300" />

    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-md transition">
      Adicionar Produto
    </button>
  </form>

  <p id="mensagem" class="text-center mt-2 font-semibold text-green-600 min-h-[1.5rem]"></p>

  <div class="w-full max-w-3xl mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <select id="filtroCategoria" class="border border-gray-300 p-3 rounded-md w-full md:w-48 focus:outline-blue-500">
      <option value="" selected>Todas as categorias</option>
      <option value="Cabelos">Cabelos</option>
      <option value="Unhas">Unhas</option>
      <option value="Pele">Pele</option>
      <option value="Maquiagem">Maquiagem</option>
    </select>

    <input type="text" id="busca" placeholder="Buscar por nome ou descrição"
      class="border border-gray-300 p-3 rounded-md flex-grow focus:outline-blue-500" oninput="listarProdutos()" />

    <select id="filtro" class="border border-gray-300 p-3 rounded-md w-full md:w-60 focus:outline-blue-500"
      onchange="listarProdutos()">
      <option value="">Todos</option>
      <option value="estoque-baixo">Estoque Baixo (&lt; 5)</option>
      <option value="preco-crescente">Preço: menor para maior</option>
      <option value="preco-decrescente">Preço: maior para menor</option>
      <option value="nome-az">Nome: A-Z</option>
      <option value="nome-za">Nome: Z-A</option>
    </select>
  </div>

  <ul id="lista" class="w-full max-w-3xl bg-white rounded-lg shadow divide-y divide-gray-200 overflow-hidden"></ul>

  <h2 class="text-3xl font-extrabold mt-12 mb-6 text-gray-900">
    Dashboard de Estoque
  </h2>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl w-full">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="font-semibold mb-4 text-lg">Estatísticas</h3>
      <ul class="space-y-2 text-gray-700">
        <li>
          <strong>Total de Produtos:</strong>
          <span id="total-produtos">...</span>
        </li>
        <li>
          <strong>Produtos com Estoque Baixo (&lt; 5):</strong>
          <span id="estoque-baixo">...</span>
        </li>
        <li>
          <strong>Valor Total em Estoque:</strong> R$
          <span id="valor-total">...</span>
        </li>
        <li>
          <strong>Produto Mais Barato:</strong>
          <span id="mais-barato">...</span>
        </li>
        <li>
          <strong>Produto Mais Caro:</strong> <span id="mais-caro">...</span>
        </li>
      </ul>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6 flex flex-col">
      <h3 class="font-semibold mb-4 text-lg">Distribuição do Estoque</h3>
      <canvas id="estoqueChart" class="flex-grow"></canvas>
    </div>
  </div>

  <script>
    const API = "http://localhost:3000/produtos";
    const API_DASHBOARD = "http://localhost:3000/admin/dashboard";
    const token = localStorage.getItem("token");

    // Função para fetch com token
    async function fetchComToken(url, options = {}) {
      options.headers = {
        ...options.headers,
        Authorization: `Bearer ${token}`,
      };
      const res = await fetch(url, options);
      if (!res.ok) throw new Error(`Erro: ${res.status}`);
      return res.json();
    }

    // Cadastro de produtos
    document
      .getElementById("form-produto")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        const nome = document.getElementById("nome").value.trim();
        const descricao = document.getElementById("descricao").value.trim();
        const preco = parseFloat(document.getElementById("preco").value);
        const estoque = parseInt(document.getElementById("estoque").value);
        const categoria = document.getElementById("categoria").value;
        const msg = document.getElementById("mensagem");
        const inputImagem = document.getElementById("input-imagem");
        const preview = document.getElementById("preview");
        const imagem = inputImagem.files[0];

        inputImagem.addEventListener("change", () => {
          const file = inputImagem.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = () => {
              preview.src = reader.result;
              preview.style.display = "block";
            };
            reader.readAsDataURL(file);
          } else {
            preview.src = "";
            preview.style.display = "none";
          }
        });

        if (!nome ||
          !descricao ||
          isNaN(preco) ||
          preco <= 0 ||
          isNaN(estoque) ||
          estoque < 0 ||
          !categoria
        ) {
          msg.textContent = "Preencha todos os campos corretamente.";
          msg.classList.replace("text-green-600", "text-red-600");
          return;
        }

        try {
          const formData = new FormData();
          formData.append("nome", nome);
          formData.append("descricao", descricao);
          formData.append("preco", preco);
          formData.append("estoque", estoque);
          formData.append("categoria", categoria);
          if (imagem) formData.append("imagem", imagem);

          await fetch(API, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          msg.textContent = "Produto adicionado com sucesso!";
          msg.classList.replace("text-red-600", "text-green-600");
          e.target.reset();
          preview.src = "";
          preview.style.display = "none";
          listarProdutos();
        } catch (err) {
          console.error("Erro ao cadastrar produto:", err);
          msg.textContent = "Erro ao cadastrar produto.";
          msg.classList.replace("text-green-600", "text-red-600");
        }
      });

    //LISTAGEM DE PRODUTOS
    document
      .getElementById("filtroCategoria")
      .addEventListener("change", listarProdutos);
    document
      .getElementById("busca")
      .addEventListener("input", listarProdutos);
    document
      .getElementById("filtro")
      .addEventListener("change", listarProdutos);

    async function listarProdutos() {
      try {
        const produtos = await fetchComToken(API);
        const busca = document.getElementById("busca").value.toLowerCase();
        const categoriaFiltro =
          document.getElementById("filtroCategoria").value;
        const filtro = document.getElementById("filtro").value;

        let filtrados = produtos.filter(
          (p) =>
            (p.nome.toLowerCase().includes(busca) ||
              p.descricao.toLowerCase().includes(busca)) &&
            (!categoriaFiltro || p.categoria === categoriaFiltro)
        );

        switch (filtro) {
          case "estoque-baixo":
            filtrados = filtrados.filter((p) => p.estoque < 5);
            break;
          case "preco-crescente":
            filtrados.sort((a, b) => a.preco - b.preco);
            break;
          case "preco-decrescente":
            filtrados.sort((a, b) => b.preco - a.preco);
            break;
          case "nome-az":
            filtrados.sort((a, b) => a.nome.localeCompare(b.nome));
            break;
          case "nome-za":
            filtrados.sort((a, b) => b.nome.localeCompare(a.nome));
            break;
        }

        renderizarProdutos(filtrados);
      } catch (err) {
        console.error("Erro ao listar produtos:", err);
      }
    }

    function renderizarProdutos(produtos) {
      const lista = document.getElementById("lista");
      lista.innerHTML = "";
      produtos.forEach((p) => {
        const li = document.createElement("li");
        li.className = "flex flex-col gap-2 px-4 py-3 hover:bg-gray-50";
        li.innerHTML = `
            <div class="flex items-center gap-4">
        ${p.imagem
            ? `<img src="http://localhost:3000/uploads/${p.imagem}" alt="${p.nome}" class="w-20 h-20 object-cover rounded-md border">`
            : ""
          }
        <div class="grid grid-cols-2 gap-2 flex-1">
          <input type="text" id="nome-${p._id}" value="${p.nome
          }" class="border p-2 rounded w-full">
          <input type="text" id="descricao-${p._id}" value="${p.descricao
          }" class="border p-2 rounded w-full">
          <input type="number" id="preco-${p._id}" value="${p.preco
          }" class="border p-2 rounded w-full">
          <input type="number" id="estoque-${p._id}" value="${p.estoque
          }" class="border p-2 rounded w-full">
          <input type="file" id="imagem-${p._id
          }" class="border p-1 rounded w-full">
        </div>
      </div>
      <p><strong>Categoria:</strong> ${p.categoria}</p>
      <div class="flex justify-end gap-2">
        <button onclick="atualizarProduto('${p._id
          }')" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">💾 Salvar</button>
        <button onclick="excluirProduto('${p._id
          }')" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">🗑️ Excluir</button>
      </div>
    `;

        lista.appendChild(li);
      });
    }

    // ATUALIZAR PRODUTO
    async function atualizarProduto(id) {
      const nome = document.getElementById(`nome-${id}`).value.trim();
      const descricao = document
        .getElementById(`descricao-${id}`)
        .value.trim();
      const preco = parseFloat(document.getElementById(`preco-${id}`).value);
      const estoque = parseInt(
        document.getElementById(`estoque-${id}`).value
      );
      const categoria = document
        .querySelector(`#nome-${id}`)
        .parentNode.nextElementSibling.textContent.replace("Categoria:", "")
        .trim();
      const fileInput = document.getElementById(`imagem-${id}`);

      try {
        const formData = new FormData();
        formData.append("nome", nome);
        formData.append("descricao", descricao);
        formData.append("preco", preco);
        formData.append("estoque", estoque);
        formData.append("categoria", categoria);
        if (fileInput && fileInput.files[0])
          formData.append("imagem", fileInput.files[0]);

        await fetch(`${API}/${id}`, {
          method: "PUT",
          headers: { Authorization: `Bearer ${token}` },
          body: formData,
        });
        listarProdutos();
      } catch (err) {
        console.error("Erro ao atualizar produto:", err);
      }
    }

    // EXCLUIR PRODUTO
    async function excluirProduto(id) {
      try {
        await fetchComToken(`${API}/${id}`, { method: "DELETE" });
        listarProdutos();
      } catch (err) {
        console.error("Erro ao excluir produto:", err);
      }
    }
    // Dashboard
    async function carregarDashboard() {
      try {
        const dados = await fetchComToken(API_DASHBOARD);

        document.getElementById("total-produtos").textContent =
          dados.totalProdutos;
        document.getElementById("estoque-baixo").textContent =
          dados.estoqueBaixo;
        document.getElementById("valor-total").textContent =
          dados.valorTotalEstoque.toFixed(2);
        document.getElementById("mais-barato").textContent = dados.maisBarato
          ? `${dados.maisBarato.nome} (R$ ${dados.maisBarato.preco.toFixed(
            2
          )})`
          : "-";
        document.getElementById("mais-caro").textContent = dados.maisCaro
          ? `${dados.maisCaro.nome} (R$ ${dados.maisCaro.preco.toFixed(2)})`
          : "-";

        const ctx = document.getElementById("estoqueChart").getContext("2d");
        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Estoque Baixo", "Estoque Normal"],
            datasets: [
              {
                label: "Produtos",
                data: [
                  dados.estoqueBaixo,
                  dados.totalProdutos - dados.estoqueBaixo,
                ],
                backgroundColor: ["#f87171", "#60a5fa"],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "bottom" },
              title: {
                display: true,
                text: "Produtos com estoque baixo vs normal",
              },
            },
          },
        });
      } catch (err) {
        console.error("Erro ao carregar dashboard:", err);
      }
    }

    // Inicialização
    listarProdutos();
    carregarDashboard();
  </script>
</body>

</html>