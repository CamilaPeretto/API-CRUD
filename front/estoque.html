<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estoque de Produtos</title>
  <link rel="shortcut icon" href="../img/carrinho-de-compras.png" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-gray-100 min-h-screen font-sans flex flex-col" style="background: linear-gradient(135deg, #d9dfff 0%, #0b7350  100%);">
    
    <!-- Navbar -->
<nav class=" top-0 left-0 w-full bg-white/30 backdrop-blur-md shadow-md py-4 px-6 flex items-center justify-between z-50">
  <!-- Logo -->
  <h1 class="text-3xl md:text-4xl font-extrabold text-teal-900 drop-shadow-md">
    StockFlow
  </h1>

  <!-- Botões -->
  <div class="flex items-center gap-3">
    <!-- Botão de adicionar -->
    <button 
      id="btn-add" 
      onclick="document.getElementById('modal').classList.remove('hidden')" 
      class="flex items-center justify-center bg-teal-700 hover:bg-teal-900 text-white font-bold py-2 px-4 rounded-md text-md"
    >
    <i data-lucide="plus"></i>
    </button>

    <!-- Botão de logout -->
    <button 
      onclick="logout()" 
      class="flex items-center gap-2 bg-teal-700 hover:bg-teal-900 text-white font-bold py-2 px-4 rounded-md transition"
    >
      <i data-lucide="log-out"></i>
      
    </button>
  </div>
</nav>
    
  <!-- Main -->
  <main class="flex-grow mt-24 w-full max-w-6xl mx-auto px-4 md:px-8 flex flex-col gap-12">
    
    <section id="dashboard" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Estatísticas -->
      <div class="bg-white/70 backdrop-blur-md rounded-2xl shadow-lg p-6 flex flex-col items-center justify-cente" >
        <h3 class="font-semibold mb-4 text-lg text-teal-800"> Estatísticas</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="bg-white/60 rounded-xl p-4 shadow flex items-center gap-3">
            <span class="text-green-600 text-2xl"></span>
            <div>
              <p class="text-sm text-gray-500">Total de Produtos</p>
              <p id="total-produtos" class="text-xl font-bold text-gray-800">...</p>
            </div>
          </div>
          <div class="bg-white/60 rounded-xl p-4 shadow flex items-center gap-3">
            <span class="text-red-500 text-2xl"></span>
            <div>
              <p class="text-sm text-gray-500">Estoque Baixo (&lt; 5)</p>
              <p id="estoque-baixo" class="text-xl font-bold text-gray-800">...</p>
            </div>
          </div>
          <div class="bg-white/60 rounded-xl p-4 shadow flex items-center gap-3">
            <span class="text-yellow-500 text-2xl"></span>
            <div>
              <p class="text-sm text-gray-500">Valor Total</p>
              <p class="text-xl font-bold text-gray-800">R$ <span id="valor-total">...</span></p>
            </div>
          </div>
          <div class="bg-white/60 rounded-xl p-4 shadow flex items-center gap-3">
            <span class="text-blue-500 text-2xl"></span>
            <div>
              <p class="text-sm text-gray-500">Mais Barato</p>
              <p id="mais-barato" class="text-xl font-bold text-gray-800">...</p>
            </div>
          </div>
          <div class="bg-white/60 rounded-xl p-4 shadow flex items-center gap-3 sm:col-span-2">
            <span class="text-purple-500 text-2xl"></span>
            <div>
              <p class="text-sm text-gray-500">Mais Caro</p>
              <p id="mais-caro" class="text-xl font-bold text-gray-800">...</p>
            </div>
          </div>
        </div>
      </div>
    
      <!-- Gráfico -->
      <div class="bg-white/70 backdrop-blur-md rounded-2xl shadow-lg p-6 flex flex-col items-center justify-center">
        <h3 class="font-semibold mb-4 text-lg text-teal-900 "> Distribuição do Estoque</h3>
        <div class="relative h-80">
          <canvas id="estoqueChart" class="w-full max-w-xs"></canvas>
        </div>
      </div>
    </section>

    <!-- Filtros + Busca -->

    <h2 class="text-3xl font-extrabold mb-6 text-teal-900">Lista de Produtos</h2>
    
    <section class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">

      <input type="text" id="busca" placeholder="Buscar por nome ou descrição"
        class="border border-gray-300 p-3 rounded-md flex-grow focus:outline-teal-600" oninput="listarProdutos()" />

      <select id="filtroCategoria" class="border border-gray-300 p-3 rounded-md w-full md:w-48 focus:outline-teal-600">
        <option value="" selected>Todas as categorias</option>
        <option value="Cabelos">Cabelos</option>
        <option value="Unhas">Unhas</option>
        <option value="Pele">Pele</option>
        <option value="Maquiagem">Maquiagem</option>
      </select>

      
      <select id="filtro" class="border border-gray-300 p-3 rounded-md w-full md:w-60 focus:outline-teal-600" onchange="listarProdutos()">
        <option value="">Todos</option>
        <option value="estoque-baixo">Estoque Baixo (&lt; 5)</option>
        <option value="preco-crescente">Preço: menor para maior</option>
        <option value="preco-decrescente">Preço: maior para menor</option>
        <option value="nome-az">Nome: A-Z</option>
        <option value="nome-za">Nome: Z-A</option>
      </select>
    </section>
    
    <!-- Lista de produtos -->
    <section>
      
      <ul id="lista" class="w-full bg-white/70 backdrop-blur-md rounded-2xl shadow divide-y divide-gray-200 overflow-hidden"></ul>
    </section>

  </main>


  <!-- Modal de cadastro -->
  <div id="modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white/90 backdrop-blur-md rounded-2xl shadow-xl p-8 w-full max-w-lg relative">
      <button onclick="document.getElementById('modal').classList.add('hidden')" class="absolute top-4 right-4 text-teal-900"><i data-lucide="x"></i></button>
      <h2 class="text-2xl font-bold mb-6 text-center text-teal-900">Adicionar Produto</h2>
      <form id="form-produto" class="grid gap-4">
        <input id="nome" type="text" placeholder="Nome do produto"
          class="border border-gray-300 p-3 rounded-md w-full focus:outline-teal-600" required />
        <input id="descricao" type="text" placeholder="Descrição"
          class="border border-gray-300 p-3 rounded-md w-full focus:outline-teal-600" required />
        <input id="preco" type="number" placeholder="Preço" min="0.01" step="0.01"
          class="border border-gray-300 p-3 rounded-md w-full focus:outline-teal-600" required />
        <input id="estoque" type="number" placeholder="Estoque" min="0" step="1"
          class="border border-gray-300 p-3 rounded-md w-full focus:outline-teal-600" required />
        <select id="categoria" class="border border-gray-300 p-3 rounded-md w-full focus:outline-teal-600" required>
          <option value="" disabled selected>Selecione a categoria</option>
          <option value="Cabelos">Cabelos</option>
          <option value="Unhas">Unhas</option>
          <option value="Pele">Pele</option>
          <option value="Maquiagem">Maquiagem</option>
        </select>
        <input id="input-imagem" type="file" accept="image/*"
          class="border border-gray-300 p-2 rounded-md w-full focus:outline-teal-600" />
        <img id="preview" src="" alt="Prévia da imagem"
          class="w-32 h-32 object-cover mt-2 hidden rounded-md border border-gray-300" />
        <button type="submit" class="bg-teal-700 hover:bg-teal-900 text-white font-semibold py-3 rounded-md transition">
          Adicionar Produto
        </button>
      </form>
      <p id="mensagem" class="text-center mt-2 font-semibold text-green-600 min-h-[1.5rem]"></p>
    </div>
  </div>

  <!-- Footer -->
  <footer class="w-full py-3 mt-14 bg-white/30 backdrop-blur-md font-semibold text-center text-gray-900 text-md">
    Feito com ❤️ por Camila
  </footer>





  <script>
    lucide.createIcons();
    const token = localStorage.getItem("token");
if (!token) {
  alert("Você precisa estar logado para acessar esta página.");
  window.location.href = "login.html";
}

    const API = "http://localhost:3000/produtos";
    const API_DASHBOARD = "http://localhost:3000/admin/dashboard";


    // Função para fetch com token
    async function fetchComToken(url, options = {}) {
  const token = localStorage.getItem("token"); // pega o token atualizado
  if (!token) throw new Error("Usuário não autenticado");

  options.headers = {
    ...options.headers,
    Authorization: `Bearer ${token}`,
  };

  const res = await fetch(url, options);
  if (!res.ok) throw new Error(`Erro: ${res.status}`);

// Se for 204 (No Content), retorna null
if (res.status === 204) return null;

return res.json();
}
function logout() {
  localStorage.removeItem("token"); // limpa o token
  window.location.href = "loja.html"; // redireciona
}
    // Cadastro de produtos
    document
      .getElementById("form-produto")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        const nome = document.getElementById("nome").value.trim();
        const descricao = document.getElementById("descricao").value.trim();
        const preco = parseFloat(document.getElementById("preco").value);
        const estoque = parseInt(document.getElementById("estoque").value);
        const categoria = document.getElementById("categoria").value;
        const msg = document.getElementById("mensagem");
        const inputImagem = document.getElementById("input-imagem");
        const preview = document.getElementById("preview");
        const imagem = inputImagem.files[0];

        inputImagem.addEventListener("change", () => {
          const file = inputImagem.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = () => {
              preview.src = reader.result;
              preview.style.display = "block";
            };
            reader.readAsDataURL(file);
          } else {
            preview.src = "";
            preview.style.display = "none";
          }
        });

        if (!nome ||
          !descricao ||
          isNaN(preco) ||
          preco <= 0 ||
          isNaN(estoque) ||
          estoque < 0 ||
          !categoria
        ) {
          msg.textContent = "Preencha todos os campos corretamente.";
          msg.classList.replace("text-green-600", "text-red-600");
          return;
        }

        try {
          const formData = new FormData();
          formData.append("nome", nome);
          formData.append("descricao", descricao);
          formData.append("preco", preco);
          formData.append("estoque", estoque);
          formData.append("categoria", categoria);
          if (imagem) formData.append("imagem", imagem);

          const response = await fetch(API, {
  method: "POST",
  headers: {
    Authorization: `Bearer ${token}`,
  },
  body: formData,
});

if (!response.ok) {
  const erro = await response.json().catch(() => ({}));
  throw new Error(erro.msg || `Erro ${response.status}: não foi possível cadastrar o produto.`);
}

msg.textContent = "Produto adicionado com sucesso!";
msg.classList.replace("text-red-600", "text-green-600");
e.target.reset();
preview.src = "";
preview.style.display = "none";
listarProdutos();

        } catch (err) {
          console.error("Erro ao cadastrar produto:", err);
          msg.textContent = "Erro ao cadastrar produto.";
          msg.classList.replace("text-green-600", "text-red-600");
        }
      });

    //LISTAGEM DE PRODUTOS
    document
      .getElementById("filtroCategoria")
      .addEventListener("change", listarProdutos);
    document
      .getElementById("busca")
      .addEventListener("input", listarProdutos);
    document
      .getElementById("filtro")
      .addEventListener("change", listarProdutos);

    async function listarProdutos() {
      try {
        const produtos = await fetchComToken(API);
        const busca = document.getElementById("busca").value.toLowerCase();
        const categoriaFiltro =
          document.getElementById("filtroCategoria").value;
        const filtro = document.getElementById("filtro").value;

        let filtrados = produtos.filter(
          (p) =>
            (p.nome.toLowerCase().includes(busca) ||
              p.descricao.toLowerCase().includes(busca)) &&
            (!categoriaFiltro || p.categoria === categoriaFiltro)
        );

        switch (filtro) {
          case "estoque-baixo":
            filtrados = filtrados.filter((p) => p.estoque < 5);
            break;
          case "preco-crescente":
            filtrados.sort((a, b) => a.preco - b.preco);
            break;
          case "preco-decrescente":
            filtrados.sort((a, b) => b.preco - a.preco);
            break;
          case "nome-az":
            filtrados.sort((a, b) => a.nome.localeCompare(b.nome));
            break;
          case "nome-za":
            filtrados.sort((a, b) => b.nome.localeCompare(a.nome));
            break;
        }

        renderizarProdutos(filtrados);
      } catch (err) {
        console.error("Erro ao listar produtos:", err);
      }
    }

    function renderizarProdutos(produtos) {
      const lista = document.getElementById("lista");
      lista.innerHTML = "";
      produtos.forEach((p) => {
        const li = document.createElement("li");
        li.className = "flex flex-col gap-2 px-4 py-3";
        li.innerHTML = `
            <div class="flex items-center gap-4">
${p.image
  ? `<img src="http://localhost:3000/uploads/${p.image}" alt="${p.nome}" class="w-30 h-20 object-cover rounded-md border">`
  : ""
}
        <div class="grid grid-cols-2 gap-2 flex-1">
          <input type="text" id="nome-${p._id}" value="${p.nome
          }" class="border p-2 rounded w-full">
          <input type="text" id="descricao-${p._id}" value="${p.descricao
          }" class="border p-2 rounded w-full">
          <input type="number" id="preco-${p._id}" value="${p.preco
          }" class="border p-2 rounded w-full">
          <input type="number" id="estoque-${p._id}" value="${p.estoque
          }" class="border p-2 rounded w-full">
        </div>
      </div>
      <p><strong>Categoria:</strong> ${p.categoria}</p>
      <div class="flex justify-end gap-2">
        <button onclick="atualizarProduto('${p._id
          }')" class="bg-teal-600 text-white px-3 py-1 rounded hover:bg-teal-700"> Salvar</button>
        <button onclick="excluirProduto('${p._id
          }')" class="bg-pink-400 text-white px-3 py-1 rounded hover:bg-pink-500"> Excluir</button>
      </div>
    `;

        lista.appendChild(li);
      });
    }

    // ATUALIZAR PRODUTO
    async function atualizarProduto(id) {
      const nome = document.getElementById(`nome-${id}`).value.trim();
      const descricao = document
        .getElementById(`descricao-${id}`)
        .value.trim();
      const preco = parseFloat(document.getElementById(`preco-${id}`).value);
      const estoque = parseInt(
        document.getElementById(`estoque-${id}`).value
      );
      const categoria = document
        .querySelector(`#nome-${id}`)
        .parentNode.nextElementSibling.textContent.replace("Categoria:", "")
        .trim();
      const fileInput = document.getElementById(`imagem-${id}`);

      try {
        const formData = new FormData();
        formData.append("nome", nome);
        formData.append("descricao", descricao);
        formData.append("preco", preco);
        formData.append("estoque", estoque);
        formData.append("categoria", categoria);
        if (fileInput && fileInput.files[0])
          formData.append("imagem", fileInput.files[0]);

        await fetch(`${API}/${id}`, {
          method: "PUT",
          headers: { Authorization: `Bearer ${token}` },
          body: formData,
        });
        listarProdutos();
      } catch (err) {
        console.error("Erro ao atualizar produto:", err);
      }
    }

    // EXCLUIR PRODUTO
    async function excluirProduto(id) {
      try {
        await fetchComToken(`${API}/${id}`, { method: "DELETE" });
        listarProdutos();
      } catch (err) {
        console.error("Erro ao excluir produto:", err);
      }
    }
    // Dashboard
    async function carregarDashboard() {
      try {
        const dados = await fetchComToken(API_DASHBOARD);

        document.getElementById("total-produtos").textContent =
          dados.totalProdutos;
        document.getElementById("estoque-baixo").textContent =
          dados.estoqueBaixo;
        document.getElementById("valor-total").textContent =
          dados.valorTotalEstoque.toFixed(2);
        document.getElementById("mais-barato").textContent = dados.maisBarato
          ? `${dados.maisBarato.nome} (R$ ${dados.maisBarato.preco.toFixed(
            2
          )})`
          : "-";
        document.getElementById("mais-caro").textContent = dados.maisCaro
          ? `${dados.maisCaro.nome} (R$ ${dados.maisCaro.preco.toFixed(2)})`
          : "-";

          const ctx = document.getElementById("estoqueChart").getContext("2d");
          new Chart(ctx, {
  type: "doughnut",
  data: {
    labels: ["Estoque Baixo", "Estoque Normal"],
    datasets: [{
      label: "Produtos",
      data: [dados.estoqueBaixo, dados.totalProdutos - dados.estoqueBaixo],
      backgroundColor: ["#A7F3D0", "#FBCFE8"], // verde pastel e rosa pastel
      borderColor: ["#6EE7B7", "#F472B6"],     // tons levemente mais escuros para contorno
      borderWidth: 2,
    }],
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: "bottom", labels: { color: "#374151", font: { size: 14 } } },
      title: {
        display: true,
        text: "Produtos com estoque baixo vs normal",
        color: "#374151",
        font: { size: 16, weight: "bold" },
      },
    },
  },
});
    } catch (err) {
      console.error("Erro ao carregar dashboard:", err);
    }
  }

    // Inicialização
    listarProdutos();
    carregarDashboard();
  </script>
</body>

</html>